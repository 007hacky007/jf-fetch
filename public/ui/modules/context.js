/**
 * Shared UI context objects: global state, DOM references, API endpoints, and static catalog data.
 */

export const state = {
	user: null,
	providers: [],
	users: [],
	searchResults: [],
	selectedSearch: new Set(),
	jobs: [],
	showMyJobs: false,
	storage: [],
	storageUpdatedAt: null,
	jobStream: null,
	isAdmin: false,
	isQueueSubmitting: false,
	usersLoading: false,
	storageIntervalId: null,
	jobNotifications: new Set(),
	providerAlerts: [],
	auditLogs: [],
	auditCursor: null,
	auditLoading: false,
	settings: null,
	settingsLoading: false,
	settingsSaving: false,
	settingsError: null,
	jobStreamConnectedAt: null, // timestamp (ms) when current SSE connection opened
	jobStreamVisibleIds: new Set(),
	jobStreamVisibleKey: '',
	defaultSearchLimit: 50,
	currentView: 'search',
	// Paging metadata for jobs list (server-side infinite scroll)
	jobsPageSize: 10,
	jobsOffset: 0,
	jobsTotal: null,
	jobsHasMore: true,
	jobsLoadingPage: false,
	kraska: {
		currentPath: '/',
		title: null,
		items: [],
		trail: [],
		selected: new Set(),
		loading: false,
		error: null,
		cache: null,
		selectedItem: null,
		variants: [],
		variantsLoading: false,
		variantsError: null,
		variantQueueing: false,
		variantsCache: null,
		mode: 'kraska',
	},
	krask2: {
		manifest: null,
		catalogs: [],
		catalogsLoading: false,
		catalogsError: null,
		catalogCache: null,
		selectedCatalogKey: null,
		items: [],
		itemsLoading: false,
		itemsError: null,
		itemsRequested: false,
		searchTerm: '',
		lastLoadedSearch: '',
		meta: {},
		itemsCache: null,
		selected: new Map(),
		queueLabel: '',
	},
};

export const els = {
	app: document.getElementById('app'),
	loginView: document.getElementById('login-view'),
	loginForm: document.getElementById('login-form'),
	loginEmail: document.getElementById('login-email'),
	loginPassword: document.getElementById('login-password'),
	loginError: document.getElementById('login-error'),
	dashboardView: document.getElementById('dashboard-view'),
	logoutBtn: document.getElementById('logout-btn'),
	userPill: document.getElementById('user-pill'),
	tabs: Array.from(document.querySelectorAll('#view-tabs [data-view]')),
	panels: Array.from(document.querySelectorAll('[data-panel]')),
	providersTab: document.getElementById('providers-tab'),
	usersTab: document.getElementById('users-tab'),
	auditTab: document.getElementById('audit-tab'),
	searchForm: document.getElementById('search-form'),
	searchQuery: document.getElementById('search-query'),
	searchLimit: document.getElementById('search-limit'),
	providerFilters: document.getElementById('provider-filters'),
	queueSelectionBtn: document.getElementById('queue-selection-btn'),
	searchResults: document.getElementById('search-results'),
	searchMeta: document.getElementById('search-meta'),
	searchWarnings: document.getElementById('search-warnings'),
	searchEmpty: document.getElementById('search-empty'),
	searchLoading: document.getElementById('search-loading'),
	searchErrors: document.getElementById('search-errors'),
	kraskaTab: document.getElementById('kraska-tab'),
	kraskaView: document.getElementById('kraska-view'),
	kraskaProviderToggle: document.getElementById('kraska-provider-toggle'),
	kraskaMenuControls: document.getElementById('kraska-menu-controls'),
	kraskaMenuView: document.getElementById('kraska-menu-view'),
	krask2View: document.getElementById('krask2-view'),
	kraskaList: document.getElementById('kraska-list'),
	kraskaLoading: document.getElementById('kraska-loading'),
	kraskaEmpty: document.getElementById('kraska-empty'),
	kraskaError: document.getElementById('kraska-error'),
	kraskaBreadcrumbs: document.getElementById('kraska-breadcrumbs'),
	kraskaBackBtn: document.getElementById('kraska-back-btn'),
	kraskaHomeBtn: document.getElementById('kraska-home-btn'),
	kraskaQueueBtn: document.getElementById('kraska-queue-btn'),
	kraskaRefreshBtn: document.getElementById('kraska-refresh-btn'),
	kraskaSelectAll: document.getElementById('kraska-select-all'),
	kraskaCacheMeta: document.getElementById('kraska-cache-meta'),
	krask2CatalogSelect: document.getElementById('krask2-catalog-select'),
	krask2SearchInput: document.getElementById('krask2-search-input'),
	krask2LoadBtn: document.getElementById('krask2-load-btn'),
	krask2RefreshBtn: document.getElementById('krask2-refresh-btn'),
	krask2ItemsRefreshBtn: document.getElementById('krask2-items-refresh-btn'),
	krask2QueueBtn: document.getElementById('krask2-queue-btn'),
	krask2Error: document.getElementById('krask2-error'),
	krask2Loading: document.getElementById('krask2-loading'),
	krask2Empty: document.getElementById('krask2-empty'),
	krask2List: document.getElementById('krask2-list'),
	krask2CatalogCacheMeta: document.getElementById('krask2-catalog-cache-meta'),
	krask2ItemsCacheMeta: document.getElementById('krask2-items-cache-meta'),
	queueView: document.getElementById('queue-view'),
	jobsList: document.getElementById('jobs-list'),
	jobsEmpty: document.getElementById('jobs-empty'),
	jobsSummary: document.getElementById('jobs-summary'),
	jobsLoading: document.getElementById('jobs-loading'),
	jobsMineToggle: document.getElementById('jobs-mine-toggle'),
	retryFailed4hBtn: document.getElementById('retry-failed-4h-btn'),
	retryFailed24hBtn: document.getElementById('retry-failed-24h-btn'),
	cancelAllQueuedBtn: document.getElementById('cancel-all-queued-btn'),
	providersList: document.getElementById('providers-list'),
	providersEmpty: document.getElementById('providers-empty'),
	providersError: document.getElementById('providers-error'),
	providersStatusWrapper: document.getElementById('providers-status-wrapper'),
	providersStatusList: document.getElementById('providers-status-list'),
	providersStatusLoading: document.getElementById('providers-status-loading'),
	providersStatusError: document.getElementById('providers-status-error'),
	providersStatusMeta: document.getElementById('providers-status-meta'),
	providerCreateBtn: document.getElementById('provider-create-btn'),
	settingsTab: document.getElementById('settings-tab'),
	settingsView: document.getElementById('settings-view'),
	settingsForm: document.getElementById('settings-form'),
	settingsError: document.getElementById('settings-error'),
	settingsLoading: document.getElementById('settings-loading'),
	settingsSaveBtn: document.getElementById('settings-save-btn'),
	settingsBaseUrl: document.getElementById('settings-base-url'),
	settingsMaxDownloads: document.getElementById('settings-max-downloads'),
	settingsMinFreeSpace: document.getElementById('settings-min-free-space'),
	settingsDefaultSearchLimit: document.getElementById('settings-default-search-limit'),
	settingsKraskaMenuCacheTtl: document.getElementById('settings-kraska-menu-cache-ttl'),
	settingsKraskaBackoffMinutes: document.getElementById('settings-kraska-backoff-minutes'),
	settingsKrask2SpacingSeconds: document.getElementById('settings-krask2-spacing-seconds'),
	settingsKraskaDebugEnabled: document.getElementById('settings-kraska-debug-enabled'),
	settingsDownloadsPath: document.getElementById('settings-downloads-path'),
	settingsLibraryPath: document.getElementById('settings-library-path'),
	settingsJellyfinUrl: document.getElementById('settings-jellyfin-url'),
	settingsJellyfinApiKey: document.getElementById('settings-jellyfin-api-key'),
	settingsJellyfinLibraryId: document.getElementById('settings-jellyfin-library-id'),
	jellyfinLibrariesSelect: document.getElementById('jellyfin-libraries-select'),
	usersTable: document.getElementById('users-table'),
	usersEmpty: document.getElementById('users-empty'),
	usersError: document.getElementById('users-error'),
	userCreateBtn: document.getElementById('user-create-btn'),
	storageMounts: document.getElementById('storage-mounts'),
	storageLoading: document.getElementById('storage-loading'),
	storageError: document.getElementById('storage-error'),
	storageRefreshBtn: document.getElementById('storage-refresh-btn'),
	auditTable: document.getElementById('audit-table'),
	auditEmpty: document.getElementById('audit-empty'),
	auditError: document.getElementById('audit-error'),
	auditLoadMore: document.getElementById('audit-load-more'),
	auditLoading: document.getElementById('audit-loading'),
	auditRefreshBtn: document.getElementById('audit-refresh-btn'),
	toastContainer: document.getElementById('toast-container'),
	modal: document.getElementById('modal'),
	assetVersionBanner: document.getElementById('asset-version-banner'),
	assetVersionReload: document.getElementById('asset-version-reload'),
	globalWarningBanner: document.getElementById('global-warning-banner'),
};

export const API = {
	login: '/api/auth/login',
	logout: '/api/auth/logout',
	session: '/api/auth/session',
	providers: '/api/providers/list',
	providerCreate: '/api/providers/create',
	providerUpdate: '/api/providers/update',
	providerDelete: '/api/providers/delete',
	providerTest: '/api/providers/test',
	providerPause: '/api/providers/pause',
	providerResume: '/api/providers/resume',
	providersStatusAll: '/api/providers/status_all',
	search: '/api/search',
	kraskaMenu: '/api/providers/kraska/menu',
	kraskaOptions: '/api/providers/kraska/options',
	krask2Catalogs: '/api/providers/krask2/catalogs.php',
	krask2CatalogItems: '/api/providers/krask2/catalog_items.php',
	krask2Meta: '/api/providers/krask2/meta.php',
	krask2Streams: '/api/providers/krask2/streams.php',
	krask2Options: '/api/providers/krask2/options.php',
	krask2BulkQueue: '/api/providers/krask2/bulk_queue.php',
	queue: '/api/jobs/queue',
	jobsList: '/api/jobs/list',
	jobCancel: '/api/jobs/cancel',
	jobPause: '/api/jobs/pause',
	jobResume: '/api/jobs/resume',
	jobRetry: '/api/jobs/retry',
	jobRetryFailed: '/api/jobs/retry_failed',
	jobCancelAll: '/api/jobs/cancel_all',
	jobPriority: '/api/jobs/priority',
	jobReorder: '/api/jobs/reorder',
	jobDelete: '/api/jobs/delete',
	jobDownload: '/api/jobs/download',
	jobStream: '/api/jobs/stream',
	jobsStats: '/api/jobs/stats',
	aria2Health: '/api/system/health.php',
	logs: '/api/system/logs.php',
	systemStorage: '/api/system/storage',
	systemHealth: '/api/system/health',
	users: '/api/users',
	audit: '/api/audit',
	settings: '/api/settings',
	jellyfinLibraries: '/api/system/jellyfin_libraries',
	systemVersion: '/api/system/version',
};

export const providerCatalog = {
	webshare: {
		key: 'webshare',
		label: 'Webshare',
		description: 'Enter your Webshare credentials. JF Fetch will request and store the API token for you.',
		defaultName: 'Webshare',
		fields: [
			{
				name: 'username',
				label: 'Webshare username (or email)',
				placeholder: 'your-email@example.com',
				required: true,
				type: 'text',
				help: 'Use the same username or email you sign in with on webshare.cz.',
			},
			{
				name: 'password',
				label: 'Webshare password',
				placeholder: 'Enter your Webshare password',
				required: true,
				type: 'password',
				help: 'The password is encrypted at rest. A fresh token is fetched automatically.',
			},
		],
	},
	kraska: {
		key: 'kraska',
		label: 'Kra.sk',
		description: 'Configure your Kra.sk credentials powering Stream-Cinema searches & downloads.',
		defaultName: 'Kra.sk',
		fields: [
			{
				name: 'username',
				label: 'Kra.sk username',
				placeholder: 'your-user',
				required: true,
				type: 'text',
				help: 'Your Kra.sk account username (not email, if distinct).',
			},
			{
				name: 'password',
				label: 'Kra.sk password',
				placeholder: '••••••••',
				required: true,
				type: 'password',
				help: 'Stored encrypted. Session + Stream-Cinema token derived automatically.',
			},
			{
				name: 'uuid',
				label: 'Static X-Uuid (optional)',
				placeholder: 'xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx',
				required: false,
				type: 'text',
				help: 'If provided, used as X-Uuid header for Stream-Cinema requests; leave blank to auto-generate.',
			},
			{
				name: 'ident_rate_limit_seconds',
				label: 'Ident fetch rate limit (seconds)',
				placeholder: '120',
				required: false,
				type: 'number',
				attributes: { min: 1, step: 1 },
				help: 'Minimum seconds between Stream-Cinema detail requests. Leave blank to use the default (120).',
			},
			{
				name: 'rate_limit_min_spacing_seconds',
				label: 'Min spacing between requests (seconds)',
				placeholder: '2',
				required: false,
				type: 'number',
				attributes: { min: 0, step: 1 },
				help: 'Minimum delay between any Stream-Cinema HTTP requests (0 keeps burst-only enforcement).',
			},
			{
				name: 'rate_limit_burst_limit',
				label: 'Burst limit (requests)',
				placeholder: '12',
				required: false,
				type: 'number',
				attributes: { min: 0, step: 1 },
				help: 'Maximum requests allowed inside the rolling window. Set 0 to disable burst tracking.',
			},
			{
				name: 'rate_limit_burst_window_seconds',
				label: 'Burst window (seconds)',
				placeholder: '30',
				required: false,
				type: 'number',
				attributes: { min: 0, step: 1 },
				help: 'Window size paired with the burst limit (e.g. 60 seconds for “5 requests per minute”).',
			},
		],
	},
	krask2: {
		key: 'krask2',
		label: 'KraSk2 (Stremio)',
		description: 'Use the Stream-Cinema Stremio manifest to browse catalogs mirrored from sc_stremio.py.',
		defaultName: 'KraSk2',
		fields: [
			{
				name: 'manifest_url',
				label: 'Manifest URL',
				placeholder: 'https://cder.club/stremio/v1/manifest.json?...',
				required: true,
				type: 'url',
				help: 'Full manifest URL copied from the Stream-Cinema addon (including query params).',
			},
			{
				name: 'user_agent',
				label: 'Custom User-Agent (optional)',
				placeholder: 'Stremio/4.4.165 …',
				required: false,
				type: 'text',
				help: 'Overrides the default Stremio UA if your endpoint expects a different client fingerprint.',
			},
			{
				name: 'http_timeout',
				label: 'HTTP timeout (seconds)',
				placeholder: '20',
				required: false,
				type: 'number',
				attributes: { min: 5, max: 60, step: 1 },
				help: 'Increase if the manifest backend is slow to respond.',
			},
			{
				name: 'search_series_episode_limit',
				label: 'Series episode sample (search)',
				placeholder: '6',
				required: false,
				type: 'number',
				attributes: { min: 1, max: 30, step: 1 },
				help: 'How many episode previews to include per series result.',
			},
			{
				name: 'search_enrich_limit',
				label: 'Movie stream enrich limit',
				placeholder: '4',
				required: false,
				type: 'number',
				attributes: { min: 0, max: 50, step: 1 },
				help: 'Number of movie search results to prefetch stream metadata for.',
			},
			{
				name: 'rate_limit_min_spacing_seconds',
				label: 'Min spacing between requests (seconds)',
				placeholder: '2',
				required: false,
				type: 'number',
				attributes: { min: 0, step: 1 },
				help: 'Minimum delay enforced between manifest/catalog/meta/stream calls. 0 keeps burst-only enforcement.',
			},
			{
				name: 'rate_limit_burst_limit',
				label: 'Burst limit (requests)',
				placeholder: '12',
				required: false,
				type: 'number',
				attributes: { min: 0, step: 1 },
				help: 'Maximum number of KraSk2 requests allowed inside the rolling window.',
			},
			{
				name: 'rate_limit_burst_window_seconds',
				label: 'Burst window (seconds)',
				placeholder: '30',
				required: false,
				type: 'number',
				attributes: { min: 0, step: 1 },
				help: 'Window size paired with the burst limit (e.g. 60 for “5 requests per minute”).',
			},
		],
	},
};

export const JOB_STREAM_EVENTS = ['job.updated', 'job.completed', 'job.failed', 'job.removed', 'job.deleted'];
